---
title: "LCC2005"
author: "Alex Chubaty"
date: "29 October 2015"
output: pdf_document
---

This is an example of a 'module group' containing several child modules:

- `caribouMovementLcc`
- `cropReprojectLccAge`
- `fireSpreadLcc`
- `forestAge`
- `forestSuccessionBeacons`
- `LccToBeaconsReclassify`


This parent module uses these children modules which have 2 different time units (month for caribou, year for others). The code in this file downloads all modules and data required to run the spades call at the end. If this is running on a Windows OS, the visualizations will be quick because a device will be opened that is not within RStudio. On a Linux machine, this will not occur, so visualization will be slow (RStudio Plot window is slow).


```{r download modules if necessary, eval=TRUE}
library(igraph)
library(raster)
library(SpaDES)

if(!exists("baseDir")) {
  if(Sys.info()[["sysname"]]=="Windows") {
    baseDir <- choose.dir(caption = "Select base directory for modules and data") %>% 
      checkPath(create=TRUE)
    } else {
      baseDir <- file.path(tempdir(), "inputs") %>% checkPath(create = TRUE)
    }
}

modules <- c("caribouMovementLcc", "cropReprojectLccAge", "fireSpreadLcc", "LCC2005",
             "forestAge", "forestSuccessionBeacons", "LccToBeaconsReclassify")

lapply(modules, downloadModule, baseDir)

```



```{r model-inputs, eval=FALSE}
# download data (these are large files!)
if (!file.exists(file.path(baseDir, "LandCoverOfCanada2005_V1_4", "LCC2005_V1_4a.tif"))) {
  url <- "ftp://ftp.ccrs.nrcan.gc.ca/ad/NLCCLandCover/LandcoverCanada2005_250m/LandCoverOfCanada2005_V1_4.zip"
  download.file(url = url,
                destfile = file.path(baseDir, "LandCoverOfCanada2005_V1_4.zip"))
  unzip(zipfile = file.path(baseDir, "LandCoverOfCanada2005_V1_4.zip"),
        exdir = file.path(baseDir, "LandCoverOfCanada2005_V1_4"))
}

if (!file.exists(file.path(baseDir, "age", "age.tif"))) {
  dir.create(file.path(baseDir, "age"))
  url <- "ftp://ftp.daac.ornl.gov/data/nacp/NA_TreeAge//data/can_age04_1km.tif"
  download.file(url = url, destfile = file.path(baseDir, "age", "age.tif"))
}

# load data
age <- raster::raster(file.path(baseDir, "age", "age.tif"))
lcc05 <- raster::raster(file.path(baseDir, "LandCoverOfCanada2005_V1_4", "LCC2005_V1_4a.tif"))
lcc05CRS <- crs(lcc05)

# Random polygon
areaKm2 <- 10000
minX <- -1072250.2
maxX <- minX + sqrt(areaKm2*1e6)
minY <- 7438877-1.6e5
maxY <- minY + sqrt(areaKm2*1e6)
meanY <- mean(c(minY, maxY))

# Add random noise to polygon
set.seed(5567913)
xAdd <- round(runif(1, -5e5, 1.5e6))
yAdd <- round(runif(1, 1e5, 5e5)) - xAdd/2
nPoints <- 20
betaPar <- 0.6
X = c(
  jitter(sort(rbeta(nPoints, betaPar, betaPar)*(maxX-minX)+minX)),
  jitter(sort(rbeta(nPoints, betaPar, betaPar)*(maxX-minX)+minX, decreasing = TRUE))
)
Y = c(
  jitter(sort(rbeta(nPoints/2, betaPar, betaPar)*(maxY-meanY)+meanY)),
  jitter(sort(rbeta(nPoints, betaPar, betaPar)*(maxY-minY)+minY, decreasing = TRUE)),
  jitter(sort(rbeta(nPoints/2, betaPar, betaPar)*(meanY-minY)+minY))
)

inputMapPolygon <- cbind(X+xAdd, Y+yAdd) %>% 
  Polygon %>%
  list %>%
  Polygons("s1") %>%
  list %>%
  SpatialPolygons(1L)
crs(inputMapPolygon) <- lcc05CRS

```

Module groups make loading multiple modules easier: only the name of the module group needs to be specified in the `simInit` call, which will then initialize the simulation with the child modules.

```{r module-group-init, eval=FALSE}
# setup simulation
outputDir <- file.path(tempdir(), "simOutputs")
cacheDir <- checkPath(file.path(outputDir, "cache"), create=TRUE)

times <- list(start = 2005.0, end = 2010.0, timeunit="year")
parameters <- list(
  .globals = list(burnStats = "nPixelsBurned"),
  .progress = list(type = "text", interval = 1),
  cropReprojectLccAge = list(useCache=TRUE),
  forestSuccessionBeacons = list(
    returnInterval = 1, startTime = times$start,
    .plotInitialTime = times$start, .plotInterval = 1),
  forestAge = list(
    returnInterval = 1, startTime = times$start+0.5,
    .plotInitialTime = times$start, .plotInterval = 1),
  fireSpreadLcc = list(
    nFires = 3, its = 1e6, drought = 1.2, persistprob = 0, returnInterval = 1,
    startTime = times$start+1, .plotInitialTime = times$start, .plotInterval = 1),
  caribouMovementLcc = list(
    N = 1e3, moveInterval = 1, startTime = times$start+1, torus = TRUE,
    glmInitialTime = NA_real_, .plotInitialTime = times$start, .plotInterval = 1)
)
modules <- list("LCC2005")
objects <- list(age = age, lcc05 = lcc05, inputMapPolygon = inputMapPolygon)

paths <- list(
  cachePath = cacheDir,
  modulePath = baseDir,
  inputPath = baseDir,
  outputPath = outputDir
)

mySim <- simInit(times = times, params = parameters, modules = modules,
                 objects = objects, paths = paths)

modules(mySim) # note the child modules are initialized
```

Now that the `mySim` object has been initialized, we can run the simulation by calling
`spades`
```{r Run SpaDES, eval=FALSE}
if(interactive() & Sys.info()[["sysname"]]=="Windows") dev() # Rstudio server device is bad, but no alternative available (which runs on Linux types) 
Plot(lcc05, new=T)
Plot(inputMapPolygon, addTo="lcc05", gp=gpar(col="yellow",lwd=2))
spades(mySim)
```

Module groups can also be used to simplify the download of multiple modules:

```{r module-group-dl, eval=FALSE}
downloadModule("SpaDES_sampleModules") # not yet implemented
```
