---
title: "LCC2005"
author: "Alex Chubaty"
date: "05 January 2015"
output: html_document
---

This is an example of a 'module group' containing several child modules:

- `caribouMovementLcc`
- `cropReprojectLccAge`
- `fireSpreadLcc`
- `forestAge`
- `forestSuccessionBeacons`
- `LccToBeaconsReclassify`

This parent module uses these children modules which have 2 different time units (month for caribou, year for others).
The code in this file downloads all modules and data required to run the spades call at the end.
If this is running on a Windows OS, the visualizations will be quick because a device will be opened that is not within RStudio.
On a Linux on OS X machine, this will not occur, so visualization will be slow (RStudio graphics device is slow).

```{r download-modules, eval=TRUE}
library(igraph)
library(raster)
library(SpaDES)

if (!exists("baseDir")) {
  baseDir <- if ( interactive() && (Sys.info()[["sysname"]] == "Windows") ) {
    choose.dir(caption = "Select base directory for modules and data")
  } else {
    file.path(tempdir(), "modules")
  } %>% checkPath(create = TRUE)
}

downloadModule("LCC2005", baseDir) # default `data=FALSE` doesn't download data
downloadData("LCC2005", baseDir) # alternatively, use `data=TRUE` above
unzip(zipfile = file.path(baseDir, "LccToBeaconsReclassify", "data", "LandCoverOfCanada2005_V1_4.zip"),
      files = "LCC2005_V1_4a.tif",
      exdir = file.path(baseDir, "LccToBeaconsReclassify", "data"))
```



```{r model-inputs, eval=TRUE}
# load data
age <- raster::raster(file.path(baseDir, "forestAge", "data", "can_age04_1km.tif"))
lcc05 <- raster::raster(file.path(baseDir, "LccToBeaconsReclassify", "data",
                                  "LCC2005_V1_4a.tif"))
lcc05CRS <- crs(lcc05)

# Random polygon
areaKm2 <- 2000
minX <- -1072250.2
maxX <- minX + sqrt(areaKm2*1e6)
minY <- 7438877-1.6e5
maxY <- minY + sqrt(areaKm2*1e6)
meanY <- mean(c(minY, maxY))

# Add random noise to polygon
set.seed(5567913)
xAdd <- round(runif(1, -5e5, 1.5e6))
yAdd <- round(runif(1, 1e5, 5e5)) - xAdd/2
nPoints <- 20
betaPar <- 0.6
X = c(
  jitter(sort(rbeta(nPoints, betaPar, betaPar)*(maxX-minX)+minX)),
  jitter(sort(rbeta(nPoints, betaPar, betaPar)*(maxX-minX)+minX, decreasing = TRUE))
)
Y = c(
  jitter(sort(rbeta(nPoints/2, betaPar, betaPar)*(maxY-meanY)+meanY)),
  jitter(sort(rbeta(nPoints, betaPar, betaPar)*(maxY-minY)+minY, decreasing = TRUE)),
  jitter(sort(rbeta(nPoints/2, betaPar, betaPar)*(meanY-minY)+minY))
)

inputMapPolygon <- cbind(X+xAdd, Y+yAdd) %>% 
  Polygon %>%
  list %>%
  Polygons("s1") %>%
  list %>%
  SpatialPolygons(1L)
crs(inputMapPolygon) <- lcc05CRS
```

Module groups make loading multiple modules easier: only the name of the module group needs to be specified in the `simInit` call, which will then initialize the simulation with the child modules.

```{r module-group-init, eval=TRUE}
# setup simulation
outputDir <- file.path(tempdir(), "simOutputs")
cacheDir <- checkPath(file.path(outputDir, "cache"), create = TRUE)

times <- list(start = 2005.0, end = 2020.0, timeunit = "year")
parameters <- list(
  .globals = list(burnStats = "nPixelsBurned"),
  .progress = list(type = "text", interval = 1),
  cropReprojectLccAge = list(useCache=TRUE),
  forestSuccessionBeacons = list(
    returnInterval = 1, startTime = times$start,
    .plotInitialTime = times$start, .plotInterval = 1),
  forestAge = list(
    returnInterval = 1, startTime = times$start+0.5,
    .plotInitialTime = times$start, .plotInterval = 1),
  fireSpreadLcc = list(
    nFires = 3, its = 1e6, drought = 1.2, persistprob = 0, returnInterval = 1,
    startTime = times$start+1, .plotInitialTime = times$start, .plotInterval = 1),
  caribouMovementLcc = list(
    N = 1e3, moveInterval = 1, startTime = times$start+1, torus = TRUE,
    glmInitialTime = NA_real_, .plotInitialTime = times$start, .plotInterval = 1)
)
modules <- list("LCC2005")
objects <- list(age = "age", lcc05 = "lcc05", inputMapPolygon = "inputMapPolygon")
paths <- list(
  cachePath = cacheDir,
  modulePath = baseDir,
  inputPath = baseDir,
  outputPath = outputDir
)

mySim <- simInit(times = times, params = parameters, modules = modules,
                 objects = objects, paths = paths)

### Simulation overview: note the child modules are initialized
moduleDiagram(mySim)
objectDiagram(mySim)
```

Now that the `mySim` object has been initialized, we can run the simulation by calling
`spades`

```{r run-SpaDES, eval=FALSE}
if ( interactive() && Sys.info()[["sysname"]] == "Windows" ) {
# Rstudio server device is bad, but no alternative available (which runs on Linux types) 
    dev()
}
Plot(lcc05, new = TRUE)
Plot(inputMapPolygon, addTo = "lcc05", gp = gpar(col = "yellow", lwd = 2))

spades(mySim)
```
